define ("mod_treasurehunt/edit",["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/ol3-layerswitcher","core/str"],function(c,a,b,d,e,f,g,h,i){function j(a,b,h,i,j,k){var V=new e.proj.Projection("EPSG:3857"),W=null,X=!0;if("undefined"!=typeof k&&null!=k){if(null!=k.custombackgroundurl){var Y=e.proj.transformExtent(k.bbox,"EPSG:4326","EPSG:3857");if(!k.geographic){var Z=Y[2]-Y[0],$=Y[3]-Y[1],_=(Y[2]+Y[0])/2,aa=(Y[3]+Y[1])/2,ba=Math.round($/k.imgheight),ca=Math.round(k.imgwidth*ba),da=Math.round(k.imgheight*ba);Y=[_-ca/2,aa-da/2,_+ca/2,aa+da/2]}W=new e.layer.Image({title:k.layername,type:k.layertype,source:new e.source.ImageStatic({url:k.custombackgroundurl,imageExtent:Y}),opacity:1})}else if(null!=k.wmsurl){var ea={source:new e.source.TileWMS({url:k.wmsurl,params:k.wmsparams}),type:k.layertype,title:k.layername};if(null!=k.bbox[0]&&null!=k.bbox[1]&&null!=k.bbox[2]&&null!=k.bbox[3]){var fa=e.proj.transformExtent(k.bbox,"EPSG:4326","EPSG:3857");ea.extent=fa}W=new e.layer.Tile(ea)}X=k.geographic}var ga={roads:{}},ha=new e.source.Vector({projection:"EPSG:3857"}),ia=new e.source.Vector({projection:"EPSG:3857"}),ja=!1,ka=!1,la=!1,ma,na,oa,pa,qa={},ra=1,sa=new e.layer.Vector({source:new e.source.Vector({projection:"EPSG:3857"})}),ta=g.createGeocoder("openstreetmap");c("#controlpanel").addClass("ui-widget-header ui-corner-all");c("<span id=\"edition\"/>").appendTo(c("#controlpanel"));c("<input type=\"radio\" name=\"controlpanel\" id=\"addradio\" value=\"add\">").appendTo(c("#edition"));c("<label>").attr("for","addradio").text(h.add).appendTo(c("#edition"));c("<input type=\"radio\" name=\"controlpanel\" id=\"modifyradio\" value=\"modify\">").appendTo(c("#edition"));c("<label>").attr("for","modifyradio").text(h.modify).appendTo(c("#edition"));c("<button id=\"savestage\"/>").attr("disabled",!0).text(h.save).appendTo(c("#controlpanel"));c("<button id=\"removefeature\"/>").attr("disabled",!0).text(h.remove).appendTo(c("#controlpanel"));if(X){c("<div id=\"searchcontainer\">").appendTo(c("#controlpanel"));c("<input type=\"search\" placeholder=\""+h.searchlocation+"\" class=\"searchaddress\"/>").appendTo(c("#searchcontainer"));c("<span class=\"ui-icon  ui-icon-search searchicon\"></span>").prependTo(c("#searchcontainer"));c("<span class=\"ui-icon  ui-icon-closethick closeicon invisible\"></span>").appendTo(c("#searchcontainer"))}c("<button id=\"addstage\" />").text(h.stage).prependTo(c("#controlpanel"));c("<button id=\"addroad\" />").text(h.road).prependTo(c("#controlpanel"));c("#addradio").button({text:!1,icons:{primary:"ui-icon-plusthick"}});c("#modifyradio").button({text:!1,icons:{primary:"ui-icon-pencil"}});c("#removefeature").button({text:!1,icons:{primary:"ui-icon-trash"}});c("#savestage").button({text:!1,icons:{primary:"ui-icon-disk"}});c("#addstage").button({icons:{primary:"ui-icon-circle-plus"}});c("#addroad").button({icons:{primary:"ui-icon-circle-plus"}});c("#edition").buttonset({disabled:!0});c("#controlpanel").removeClass("invisible");c("<ul id=\"stagelist\"/>").prependTo(c("#stagelistpanel"));c("#stagelist").sortable({handle:".handle",tolerance:"pointer",zIndex:9999,opacity:.5,forcePlaceholderSize:!0,cursorAt:{top:-7},cursor:"n-resize",axis:"y",items:"li:not(:hidden , .blocked)",helper:"clone",start:function start(a,b){var d=b.item.attr("roadid"),e=b.item.index("li[roadid=\""+d+"\"]"),f=c(this).data("ui-sortable").scrollParent,g=f[0].scrollHeight-f[0].clientHeight-b.helper.height();b.item.data("start_pos",e);c(this).data("maxScrollTop",g)},sort:function sort(){var a=c(this).data("ui-sortable").scrollParent,b=c(this).data("maxScrollTop");if(a.scrollTop()>b){a.scrollTop(b)}},update:function update(a,b){var d=b.item.data("start_pos"),e=b.item.attr("roadid"),f=b.item.index("li[roadid=\""+e+"\"]"),g=c(this).children("li[roadid=\""+e+"\"]"),h=c(g).length,j;if(d===f){return}if(d<f){for(j=d;j<=f;j++){l(g,h,j,ha,ia,ga.roads[e].vector)}}else{for(j=f;j<=d;j++){l(g,h,j,ha,ia,ga.roads[e].vector)}}G();ja=!0}}).disableSelection();function l(a,b,d,e,f,g){var h,i=c(a).get([d]),j=c(i).attr("roadid");h=Math.abs(c(i).index("li[roadid=\""+j+"\"]")-b);c(i).attr("stageposition",h);c(i).find(".sortable-number").text(h);if(c(i).hasClass("ui-selected")){ma=h}M(parseInt(c(i).attr("stageid"),10),h,parseInt(c(i).attr("roadid"),10),e,f,g)}c("<ul id=\"roadlist\"/>").appendTo(c("#roadlistpanel"));window.app={};var ua=window.app;ua.generateResizableControl=function(a){var b=document.createElement("button"),c=document.createElement("div");b.innerHTML="<>";b.id="egrip";c.className="ol-control ol-unselectable egrip-container";c.appendChild(b);e.control.Control.call(this,{element:c,target:(a||{}).target})};e.inherits(ua.generateResizableControl,e.control.Control);var va=new e.style.Style({fill:new e.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),stroke:new e.style.Stroke({color:"#6C0492",width:2}),image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#ffcc33"}),stroke:new e.style.Stroke({color:"#000000",width:2})}),text:new e.style.Text({textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#6C0492",width:3.5})})}),wa=new e.style.Style({fill:new e.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new e.style.Stroke({color:"#FAC30B",width:2}),image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#ffcc33"}),stroke:new e.style.Stroke({color:"#000000",width:2})}),text:new e.style.Text({textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#ffcc33",width:3.5})}),zIndex:"Infinity"}),xa=new e.layer.Vector({source:new e.source.Vector({projection:"EPSG:3857"}),visible:!1}),ya=new e.layer.Group({title:h.basemaps,layers:[new e.layer.Tile({title:h.aerialmap,type:"base",visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({title:h.roadmap,type:"base",visible:!0,source:new e.source.OSM})]});if(null!=W){if(k.onlybase){ya.getLayers().clear()}ya.getLayers().push(W)}var za=document.getElementById("popup"),Aa=document.getElementById("popup-content"),Ba=document.getElementById("popup-closer"),Ca=new e.Overlay({element:za,autoPan:!0,autoPanAnimation:{duration:250}});Ba.onclick=function(){Ca.setPosition(void 0);Ba.blur();return!1};var Da=new e.control.LayerSwitcher,Ea=new e.Map({layers:[ya,xa],overlays:[Ca],projection:V,renderer:"canvas",target:"mapedit",view:new e.View({center:[0,0],zoom:2,minZoom:2}),controls:e.control.defaults().extend([Da,new ua.generateResizableControl({target:document.getElementById("stagelistpanel")})])});function m(a){var b=a.coordinate,c=e.proj.toLonLat(b,Ea.getView().getProjection()),d=e.coordinate.toStringHDMS(c),f="<a target=\"street\" href=\"http://maps.google.com/?cbll="+c[1]+","+c[0]+"&cbp=12,20.09,,0,5&layer=c\"><img src=\"pix/my_location.png\" width=\"16\" /></a>";Aa.innerHTML="<code>"+f+""+d+"</code>";Ca.setPosition(b)}Ea.on("click",function(a){if(!Ga.getActive()&&!Fa.getActive()&&(null===k||k.geographic)){m(a)}});Da.showPanel();c("#stagelistpanel").resizable({handles:{e:c("#egrip")},resize:function resize(a,b){b.size.height=b.originalSize.height},stop:function stop(){Ea.updateSize()},cancel:""});var Fa={init:function init(){this.select=new e.interaction.Select({filter:function filter(a){if(qa[a.getId()]){return!0}return!1},style:function style(a){var b=new e.style.Fill({color:"rgba(255,255,255,0.4)"}),c=new e.style.Stroke({color:"#3399CC",width:2}),d=[new e.style.Style({image:new e.style.Circle({fill:b,stroke:c,radius:5}),fill:b,stroke:c,text:new e.style.Text({text:""+a.get("stageposition"),textAlign:"center",scale:1.3,fill:new e.style.Fill({color:"#fff"}),stroke:new e.style.Stroke({color:"#3399CC",width:3.5})}),zIndex:"Infinity"})];return d}});Ea.addInteraction(this.select);this.modify=new e.interaction.Modify({features:this.select.getFeatures(),style:new e.style.Style({image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#3399CC"}),stroke:new e.style.Stroke({color:"#000000",width:2})})}),deleteCondition:function deleteCondition(a){return e.events.condition.shiftKeyOnly(a)&&e.events.condition.singleClick(a)}});Ea.addInteraction(this.modify);this.setEvents()},setEvents:function setEvents(){pa=this.select.getFeatures();this.select.on("change:active",function(){pa.clear();B()});this.select.on("select",function(){if(0<pa.getLength()){A()}else{B()}});this.modify.on("modifyend",function(a){G();o(a.features,ia,ha,ga.roads[na].vector);ja=!0})},getActive:function getActive(){return this.select.getActive()&&this.modify.getActive()?!0:!1},setActive:function setActive(a){this.select.setActive(a);this.modify.setActive(a)}};Fa.init();var Ga={init:function init(){Ea.addInteraction(this.Polygon);this.Polygon.setActive(!1);this.setEvents()},Polygon:new e.interaction.Draw({source:xa.getSource(),type:"Polygon",style:new e.style.Style({fill:new e.style.Fill({color:"rgba(0, 0, 0, 0.05)"}),stroke:new e.style.Stroke({color:"#FAC30B",width:2}),image:new e.style.Circle({radius:5,fill:new e.style.Fill({color:"#ffcc33"}),stroke:new e.style.Stroke({color:"#000000",width:2})}),zIndex:"Infinity"})}),setEvents:function setEvents(){this.Polygon.on("drawend",function(a){la=!1;if(ka){xa.getSource().clear();ka=!1}else{a.feature.setProperties({roadid:na,stageid:oa,stageposition:ma});qa[ra]=!0;a.feature.setId(ra);ra++;ga.roads[na].vector.getSource().addFeature(a.feature);n(a.feature,ia,ha);xa.getSource().clear();G();ja=!0}});this.Polygon.on("drawstart",function(){la=!0})},getActive:function getActive(){return this.Polygon.getActive()},setActive:function setActive(a){if(a){this.Polygon.setActive(!0)}else{this.Polygon.setActive(!1)}Ea.getTargetElement().style.cursor=a?"none":""}};c(document).keyup(function(a){if(27===a.keyCode&&la){ka=!0;Ga.Polygon.finishDrawing()}});Ga.init();Ga.setActive(!1);Fa.setActive(!1);E();var Ha=new e.interaction.Snap({source:xa.getSource()});Ea.addInteraction(Ha);(function(a){var b=f.call([{methodname:"mod_treasurehunt_fetch_treasurehunt",args:{treasurehuntid:a}}]);b[0].done(function(a){c(".treasurehunt-editor-loader").hide();if(a.status.code){d.alert("Error",a.status.msg,"Continue")}else{var b,f=a.treasurehunt.stages,g=new e.format.GeoJSON,h,j=a.treasurehunt.roads;if(!Array.isArray(j)){j=Object.values(j)}j.forEach(function(a){a.blocked=!0==a.blocked;u(a.id,a.name,a.blocked);h=g.readFeatures(a.stages,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"});ia.addFeatures(h);delete a.stages;b=new e.layer.Vector({source:new e.source.Vector({projection:"EPSG:3857"}),updateWhileAnimating:!0,style:q});h.forEach(function(c){if(null===c.getGeometry()){c.setGeometry(new e.geom.MultiPolygon([]))}for(var d=c.getGeometry().getPolygons(),f="empty",g=c.get("stageposition"),h=c.get("name"),j=c.get("clue"),k=c.getId(),l=a.blocked,m=0,n;m<d.length;m++){n=new e.Feature(c.getProperties());n.setProperties({stageid:k});var o=d[m];n.setGeometry(o);n.setId(ra);if(0==m){f=ra}else{f=f+","+ra}ra++;b.getSource().addFeature(n)}c.setProperties({idFeaturesPolygons:""+f});t(k,a.id,g,h,j,l);if(0===d.length){y(k)}});a.vector=b;Ea.addLayer(b);ga.roads[a.id]=a});x();if("undefined"!=typeof ga.roads[i]){na=i;if(ga.roads[na].blocked){D()}else{C()}K(na,ga.roads[na].vector,Ea)}else{s(ga.roads,Ea)}}}).fail(function(a){c(".treasurehunt-editor-loader").hide();console.log(a);d.exception(a)})})(b);function n(a,b,c){var d=a.get("stageid"),e=a.get("roadid"),f=c.getFeatureById(d);if(!f){f=b.getFeatureById(d).clone();f.setId(d);c.addFeature(f)}if("empty"===f.get("idFeaturesPolygons")){f.setProperties({idFeaturesPolygons:""+a.getId()});z(d,e)}else{f.setProperties({idFeaturesPolygons:f.get("idFeaturesPolygons")+","+a.getId()})}f.getGeometry().appendPolygon(a.getGeometry())}function o(a,b,c,d){a.forEach(function(a){var f=a.get("stageid"),g=c.getFeatureById(f),h;if(!g){g=b.getFeatureById(f).clone();g.setId(f);c.addFeature(g)}var k=new e.geom.MultiPolygon([]);h=g.get("idFeaturesPolygons").split(",");for(var l=0,m=h.length;l<m;l++){k.appendPolygon(d.getSource().getFeatureById(h[l]).getGeometry().clone())}g.setGeometry(k)})}function p(a,b,c,d){a.forEach(function(a){var f=a.get("stageid"),g=a.get("roadid"),h=c.getFeatureById(f),k,l;if(!h){h=b.getFeatureById(f).clone();h.setId(f);c.addFeature(h)}var m=new e.geom.MultiPolygon([]);k=h.get("idFeaturesPolygons").split(",");for(var n=0,o=k.length;n<o;n++){if(k[n]!=a.getId()){m.appendPolygon(d.getSource().getFeatureById(k[n]).getGeometry().clone())}else{l=n}}h.setGeometry(m);if(m.getPolygons().length){k.splice(l,1);h.setProperties({idFeaturesPolygons:k.join()})}else{h.setProperties({idFeaturesPolygons:"empty"});y(f,g)}})}function q(a){var b=a.get("stageposition");if(!isNaN(b)){wa.getText().setText(""+b);va.getText().setText(""+b)}if(qa[a.getId()]){return[wa]}return[va]}function r(a,b){a.forEach(function(a){b.getSource().removeFeature(a)});a.clear()}function s(a,b){var d=0;for(var e in a){if(ga.roads.hasOwnProperty(e)){d=1;na=e;if(a[na].blocked){D()}else{C()}K(na,a[na].vector,b);break}}if(0==d){D();c("#addroad").addClass("highlightbutton");c("#stagelistpanel").addClass("invisible");b.updateSize()}}function t(a,b,d,e,f,g){if(1>c("#stagelist li[stageid=\""+a+"\"]").length){var h=c("<li stageid=\""+a+"\" roadid=\""+b+"\" stageposition=\""+d+"\"/>").appendTo(c("#stagelist"));h.addClass("ui-corner-all").append("<div class='stagename'>"+e+"</div>").append("<div class='modifystage'><span class='ui-icon ui-icon-pencil'></span><span class='ui-icon ui-icon-info' data-id='#dialoginfo"+a+"'><div id='dialoginfo"+a+"' title='"+e+"'>"+f+"</div></span></div>");if(g){h.addClass("blocked").prepend("<div class='nohandle validstage'><span class='ui-icon ui-icon-locked'></span><span class='sortable-number'>"+d+"</span></div>")}else{h.prepend("<div class='handle validstage'><span class='ui-icon ui-icon-arrowthick-2-n-s'></span><span class='sortable-number'>"+d+"</span></div>");h.children(".modifystage").prepend("<span class='ui-icon ui-icon-trash'></span>")}c("#dialoginfo"+a).dialog({maxHeight:500,autoOpen:!1})}else{console.log("El li con "+a+" no ha podido crearse porque ya existia uno")}}function u(a,b,d){if(1>c("#roadlist li[roadid=\""+a+"\"]").length){var e=c("<li roadid=\""+a+"\" blocked=\""+d+"\"/>").appendTo(c("#roadlist"));e.addClass("ui-corner-all").append("<div class='roadname'>"+b+"</div>").append("<div class='modifyroad'><span class='ui-icon ui-icon-trash'></span><span class='ui-icon ui-icon-pencil'></span></div>")}}function v(a){var b=c("#roadlist li[roadid=\""+a+"\"]");if(0<b.length){var d=c("#stagelist li[roadid=\""+a+"\"]");b.remove();d.remove()}}function w(a,b,d,e){var f=c("#stagelist li[stageid=\""+a+"\"]");if(0<f.length){var g=f.attr("roadid"),h=f.index("li[roadid=\""+g+"\"]");f.remove();var j=c("#stagelist li[roadid='"+g+"']");J(j);for(var k=j.length,m=0;m<=h-1;m++){l(j,k,m,b,d,e)}}}function x(){c("#stagelist li").sort(function(d,a){var b=parseInt(c(d).attr("stageposition")),e=parseInt(c(a).attr("stageposition"));return b<e?1:b>e?-1:0}).appendTo(c("#stagelist"))}function y(a,b){var d=c("#stagelist li[stageid=\""+a+"\"]");d.children(".handle,.nohandle").addClass("invalidstage").removeClass("validstage");if(b){c("label[for='addradio']").addClass("highlightbutton");var e=c("#stagelist li[roadid='"+b+"']");if(2<=e.length){c("#erremptystage").removeClass("invisible")}}}function z(a,b){var d=c("#stagelist li[stageid=\""+a+"\"]");d.children(".handle, .nohandle").addClass("validstage").removeClass("invalidstage");if(b){c("label[for='addradio']").removeClass("highlightbutton");var e=c("#stagelist li[roadid='"+b+"']");if(0===e.find(".invalidstage").length){c("#erremptystage").addClass("invisible")}}}function A(){c("#removefeature").button("option","disabled",!1)}function B(){c("#removefeature").button("option","disabled",!0)}function C(){c("#addstage").button("option","disabled",!1)}function D(){c("#addstage").button("option","disabled",!0)}function E(){c("#edition").find("input:radio");c("#edition").find("input:radio").prop("checked",!1).end().buttonset("refresh");c("#edition").buttonset("disable");Ga.setActive(!1);Fa.setActive(!1)}function F(){c("#edition").buttonset("enable")}function G(){c("#savestage").button("option","disabled",!1)}function H(){c("#savestage").button("option","disabled",!0)}function I(a,b,c){var d=a.getView();if(c){d.fit(c,{duration:700})}else{d.animate({zoom:19,center:b,duration:700})}}function J(a){if(0<a.length){c("#stagelistpanel").removeClass("invisible");Ea.updateSize()}else{c("#stagelistpanel").addClass("invisible");Ea.updateSize()}if(2>a.length){c("#addstage").addClass("highlightbutton");c("#errvalidroad").removeClass("invisible");c("#erremptystage").addClass("invisible")}else if(0<a.find(".invalidstage").length){c("#addstage").removeClass("highlightbutton");c("#errvalidroad").addClass("invisible");c("#erremptystage").removeClass("invisible")}else{c("#addstage").removeClass("highlightbutton");c("#errvalidroad").addClass("invisible");c("#erremptystage").addClass("invisible")}}function K(a,b,d){c("#stagelist li").removeClass("ui-selected").hide();var f=c("#stagelist li[roadid='"+a+"']");f.show();J(f);c("#roadlist li[roadid='"+a+"']").addClass("ui-selected");d.getLayers().forEach(function(a){if(a instanceof e.layer.Vector){a.setVisible(!1)}});b.setVisible(!0);if(0<b.getSource().getFeatures().length){I(d,null,b.getSource().getExtent())}}function L(a,b,c,d,e,f){b.getSource().clear();d.clear();qa={};var g=e.getFeatureById(c);if(!g){g=f.getFeatureById(c);if(!g){a.changed();return}}if("empty"===g.get("idFeaturesPolygons")){a.changed();return}for(var h=g.get("idFeaturesPolygons").split(","),k=0,l=h.length;k<l;k++){b.getSource().addFeature(a.getSource().getFeatureById(h[k]).clone());qa[h[k]]=!0}if(b.getSource().getFeatures().length){I(Ea,null,b.getSource().getExtent())}}function M(a,b,c,d,e,f){var g=d.getFeatureById(a),h;if(!g){g=e.getFeatureById(a).clone();g.setId(a);d.addFeature(g)}g.setProperties({stageposition:b});if("empty"!==g.get("idFeaturesPolygons")){h=g.get("idFeaturesPolygons").split(",");for(var k=0,l=h.length;k<l;k++){f.getSource().getFeatureById(h[k]).setProperties({stageposition:b})}}}function N(a,b){window.location.href="editstage.php?cmid="+b+"&id="+a}function O(a,b){window.location.href="editstage.php?cmid="+b+"&roadid="+a}function P(a,b){window.location.href="editroad.php?cmid="+b+"&id="+a}function Q(a){window.location.href="editroad.php?cmid="+a}function R(a,b,e,g,h){c(".treasurehunt-editor-loader").show();var i=f.call([{methodname:"mod_treasurehunt_delete_road",args:{roadid:a,treasurehuntid:g,lockid:h}}]);i[0].done(function(f){c(".treasurehunt-editor-loader").hide();if(f.status.code){d.alert("Error",f.status.msg,"Continue")}else{v(a);Ea.removeLayer(ga.roads[a].vector);delete ga.roads[a];s(ga.roads,Ea);E();for(var g=e.getFeatures(),h=0;h<g.length;h++){if(a===g[h].get("roadid")){var j=b.getFeatureById(g[h].getId());if(j){b.removeFeature(j)}e.removeFeature(g[h])}}}}).fail(function(a){c(".treasurehunt-editor-loader").hide();console.log(a);d.exception(a)})}function S(a,b,e,g,h,i){c(".treasurehunt-editor-loader").show();var j=f.call([{methodname:"mod_treasurehunt_delete_stage",args:{stageid:a,treasurehuntid:h,lockid:i}}]);j[0].done(function(f){c(".treasurehunt-editor-loader").hide();if(f.status.code){d.alert("Error",f.status.msg,"Continue")}else{var h=!1,k,l=b.getFeatureById(a);w(a,b,e,g);if(!l){l=e.getFeatureById(a);if("empty"!==l.get("idFeaturesPolygons")){h=l.get("idFeaturesPolygons").split(",")}e.removeFeature(l)}else{if("empty"!==l.get("idFeaturesPolygons")){h=l.get("idFeaturesPolygons").split(",")}b.removeFeature(l)}if(h){for(var m=0,n=h.length;m<n;m++){k=g.getSource().getFeatureById(h[m]);g.getSource().removeFeature(k)}}}}).fail(function(a){c(".treasurehunt-editor-loader").hide();console.log(a);d.exception(a)})}function T(a,b,g,h,i,j){c(".treasurehunt-editor-loader").show();var k=new e.format.GeoJSON,l=a.getFeatures(),m=[],n;l.forEach(function(a){n=a.clone();n.unset("idFeaturesPolygons");n.unset("name");n.unset("clue");n.unset("treasurehuntid");n.setId(a.getId());m.push(n)});var o=k.writeFeaturesObject(m,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}),p=f.call([{methodname:"mod_treasurehunt_update_stages",args:{stages:o,treasurehuntid:g,lockid:j}}]);p[0].done(function(e){c(".treasurehunt-editor-loader").hide();if(e.status.code){d.alert("Error",e.status.msg,"Continue")}else{var f;a.forEachFeature(function(a){f=b.getFeatureById(a.getId());f.setProperties(a.getProperties());f.setGeometry(a.getGeometry())});a.clear();H();ja=!1;if("function"==typeof h&&i instanceof Array){h.apply(null,i)}}}).fail(function(a){c(".treasurehunt-editor-loader").hide();console.log(a);d.alert("Error",a.message,"Continue")})}c(".searchaddress").autocomplete({minLength:4,source:function source(a,b){var c=a.term;ta.geocode(c,function(a){if(!a[0]){b();return}for(var c=[],d=0,e=a.length;d<e;d++){var f,g;f=a[d].getLatitude();g=a[d].getLongitude();var h={value:a[d].totalName,latitude:f,longitude:g,boundingbox:a[d].boundingbox};c[d]=h}b(c)})},select:function select(a,b){if(b.item.boundingbox){var c=[parseFloat(b.item.boundingbox[2]),parseFloat(b.item.boundingbox[0]),parseFloat(b.item.boundingbox[3]),parseFloat(b.item.boundingbox[1])];c=e.proj.transformExtent(c,"EPSG:4326","EPSG:3857");I(Ea,null,c)}else{var d=e.proj.fromLonLat([b.item.longitude,b.item.latitude]);I(Ea,d)}},autoFocus:!0}).on("click",function(){c(this).autocomplete("search",c(this).value)});c.ui.autocomplete.prototype._resizeMenu=function(){var a=this.menu.element;a.outerWidth(this.element.outerWidth())};c("#addstage").on("click",function(){if(ja){T(ha,ia,b,O,[na,a],j)}else{O(na,a)}});c("#addroad").on("click",function(){if(ja){T(ha,ia,b,Q,[a],j)}else{Q(a)}});c("#removefeature").on("click",function(){d.confirm(h.areyousure,h.removewarning,h.confirm,h.cancel,function(){p(pa,ia,ha,ga.roads[na].vector);r(pa,ga.roads[na].vector);B();G();ja=!0})});c("#savestage").on("click",function(){T(ha,ia,b,null,null,j)});c("#stagelist").on("click",".ui-icon-info, .ui-icon-alert",function(){var a=c(this).data("id");c(a).dialog("open");c(".ui-dialog :button").blur()});c("#stagelist").on("click",".ui-icon-trash",function(){var a=c(this).parents("li");d.confirm(h.areyousure,h.removewarning,h.confirm,h.cancel,function(){var c=parseInt(a.attr("stageid"));S(c,ha,ia,ga.roads[na].vector,b,j)})});c("#stagelist").on("click",".ui-icon-pencil",function(){var d=parseInt(c(this).parents("li").attr("stageid"));if(ja){T(ha,ia,b,N,[d,a],j)}else{N(d,a)}});var Ia="off";c("input[name=controlpanel]:radio").on("click",function(){var a=Ia,b=c(this).prop("id");if(b==a){c("#edition").find("input:radio").buttonset().prop("checked",!1).end().buttonset("refresh");b="off"}Ia=b;if("addradio"===b){Ga.setActive(!0);Fa.setActive(!1)}else if("modifyradio"===b){Ga.setActive(!1);Fa.setActive(!0)}else{Ga.setActive(!1);Fa.setActive(!1)}});c("#stagelist").on("click","li",function(a){if(c(a.target).is(".handle ,.nohandle, .ui-icon , .sortable-number")){a.preventDefault();return}c(this).addClass("ui-selected").siblings().removeClass("ui-selected");ma=parseInt(c(this).attr("stageposition"));oa=parseInt(c(this).attr("stageid"));L(ga.roads[na].vector,sa,oa,pa,ha,ia);F();if(0<c(this).find(".invalidstage").length){c("label[for='addradio']").addClass("highlightbutton")}else{c("label[for='addradio']").removeClass("highlightbutton")}if(la){ka=!0;Ga.Polygon.finishDrawing()}});c("#roadlist").on("click","li",function(a){if(c(a.target).is(".ui-icon")){a.preventDefault();return}c(this).addClass("ui-selected").siblings().removeClass("ui-selected");qa={};if(la){ka=!0;Ga.Polygon.finishDrawing()}na=c(this).attr("roadid");var b=c(this).attr("blocked");if(parseInt(b)||"true"===b){D()}else{C()}K(na,ga.roads[na].vector,Ea);E();var d;if("fixed"===c("header[role=banner]").css("position")){d=parseInt(c(".treasurehunt-editor").offset().top)-parseInt(c("header[role=banner]").outerHeight(!0))}else{d=parseInt(c(".treasurehunt-editor").offset().top)}c("html, body").animate({scrollTop:d},500)});c("#roadlist").on("click",".ui-icon-pencil",function(){var d=parseInt(c(this).parents("li").attr("roadid"));if(ja){T(ha,ia,b,P,[d,a],j)}else{P(d,a)}});c("#roadlist").on("click",".ui-icon-trash",function(){var a=c(this).parents("li");d.confirm(h.areyousure,h.removeroadwarning,h.confirm,h.cancel,function(){var c=parseInt(a.attr("roadid"));R(c,ha,ia,b,j)})});Ea.on("pointermove",function(a){if(a.dragging||Ga.getActive()||!Fa.getActive()){return}var b=Ea.getEventPixel(a.originalEvent),c=Ea.forEachFeatureAtPixel(b,function(a){if(qa[a.getId()]){var b=!1;pa.forEach(function(c){if(a===c){b=!0}});return b?!1:!0}return!1});Ea.getTargetElement().style.cursor=c?"pointer":""});c(document).on("touchend",".ui-dialog-titlebar-close",function(){c(this).parent().siblings(".ui-dialog-content").dialog("close")});function U(a){return a?"removeClass":"addClass"}c(".searchaddress").on("input",function(){c(".closeicon")[U(this.value)]("invisible")});c(".closeicon").on("touchstart click",function(a){a.preventDefault();c(this).addClass("invisible");c(".searchaddress").val("").change().autocomplete("close")});window.onbeforeunload=function(a){var b=h.savewarning,a=a||window.event;if(ja){if(a){a.returnValue=b}return b}}}return{edittreasurehunt:function edittreasurehunt(a,b,c,d,e){var f=["stage","road","aerialmap","roadmap","basemaps","add","modify","save","remove","searchlocation","savewarning","removewarning","areyousure","removeroadwarning","confirm","cancel"],g=f.map(function(a){return{key:a,component:"treasurehunt"}});i.get_strings(g).done(function(g){for(var h=[],k=0;k<f.length;k++){h[f[k]]=g[k]}if("undefined"!=typeof e&&null!==e&&null!==e.custombackgroundurl){var l=new Image;l.addEventListener("load",function(){e.imgwidth=this.naturalWidth;e.imgheight=this.naturalHeight;j(a,b,h,c,d,e)});l.src=e.custombackgroundurl}else{j(a,b,h,c,d,e)}})}}});
//# sourceMappingURL=edit.min.js.map
