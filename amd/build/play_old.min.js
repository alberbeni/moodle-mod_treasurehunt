define ("mod_treasurehunt/play_old",["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/viewgpx","mod_treasurehunt/jquery.truncate","mod_treasurehunt/jquery.mobile-config","mod_treasurehunt/jquerymobile"],function(a,b,c,d,e,f){console.log("loading play.js with jquery "+a().jquery);return{playtreasurehunt:function playtreasurehunt(a,b,c,d,e,f,h,i,j,k){console.log("loading i18n strings");["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"].map(function(a){return{key:a,component:"treasurehunt"}});i18n=i18nplay;if("undefined"!=typeof k&&null!==k&&null!==k.custombackgroundurl){console.log("Detecting custom background image dimensions.");var l=new Image;l.addEventListener("load",function(){k.imgwidth=this.naturalWidth;k.imgheight=this.naturalHeight;console.log("image is "+this.naturalWidth+"x"+this.naturalHeight+"pixels");g(i18n,a,b,c,d,e,f,h,i,j,k)});l.src=k.custombackgroundurl}else{g(i18n,a,b,c,d,e,f,h,i,j,k)}}};function g(g,h,i,j,k,l,m,n,o,p,q){console.log("init player Openlayers");a.mobile.loading("show");var H=null,I=!0,J=19;if("undefined"!=typeof q&&null!==q){if(null!=q.custombackgroundurl){console.log("config custom background image");var K=c.proj.transformExtent(q.bbox,"EPSG:4326","EPSG:3857");if(!q.geographic){var L=K[2]-K[0],M=K[3]-K[1],N=(K[2]+K[0])/2,O=(K[3]+K[1])/2,P=Math.round(M/q.imgheight),Q=Math.round(q.imgwidth*P),R=Math.round(q.imgheight*P);K=[N-Q/2,O-R/2,N+Q/2,O+R/2];J=5}H=new c.layer.Image({title:q.layername,name:q.layername,type:q.layertype,source:new c.source.ImageStatic({url:q.custombackgroundurl,imageExtent:K}),opacity:1})}else if(null!==q.wmsurl){console.log("config custom wms server: "+q.wmsurl);var S={source:new c.source.TileWMS({url:q.wmsurl,params:q.wmsparams}),type:q.layertype,title:q.layername,name:q.layername};if(null!==q.bbox[0]&&null!==q.bbox[1]&&null!==q.bbox[2]&&null!==q.bbox[3]){var T=c.proj.transformExtent(q.bbox,"EPSG:4326","EPSG:3857");S.extent=T}H=new c.layer.Tile(S)}I=q.geographic}if(!1===I){console.log("geographic tools disabled");j=!0;a("#autolocate").hide()}var U=b.imageUrl("success_mark","treasurehunt"),V=b.imageUrl("failure_mark","treasurehunt"),W=b.imageUrl("my_location","treasurehunt"),X=e.createGeocoder("openstreetmap"),Y={},Z,$=0,_=0,aa=[],ba=[],ca=!1,da=!1,ea=!1,fa=!1,ga=!1,ha=!0,ia=!1,ja=new c.style.Text({textAlign:"center",scale:1.3,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#000",width:3.5})}),ka=new c.style.Text({textAlign:"center",scale:1.4,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#3399CC",width:3.5})}),la=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:U}),text:ja,zIndex:"Infinity"}),ma=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:V}),text:ja,zIndex:"Infinity"}),na=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:U}),text:ka,zIndex:"Infinity"}),oa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:V}),text:ka,zIndex:"Infinity"}),pa=new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:new c.style.Stroke({color:[255,255,255,1],width:2})})}),qa=new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.3]}),stroke:new c.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),ra=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.35,src:W})}),sa=[],ta=new c.format.GeoJSON,ua=new c.source.Vector({projection:"EPSG:3857"}),va=new c.layer.Vector({source:ua,style:function(a){var b=a.get("stageposition");if(0===b){var d=new c.style.Fill({color:"rgba(255,255,255,0.4)"}),e=new c.style.Stroke({color:"#3399CC",width:1.25}),f=new c.style.Style({image:new c.style.Circle({fill:d,stroke:e,radius:5}),fill:d,stroke:e,text:new c.style.Text({text:g.startfromhere,textAlign:"center",fill:new c.style.Fill({color:"rgb(255,255,255)"}),stroke:new c.style.Stroke({color:"#3399CC",width:5})})});return[f]}if(!a.get("geometrysolved")){ma.getText().setText(""+b);return[ma]}la.getText().setText(""+b);return[la]}}),wa=new c.layer.Tile({visible:!1,source:new c.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});wa.set("name",g.aerialview);var xa=new c.layer.Tile({source:new c.source.OSM});xa.set("name",g.roadview);var ya=[],za=[];if(null===q||!1===q.onlybase){ya=[wa,xa]}if(null!==H){if("overlay"!=q.layertype){ya.push(H)}else{za.push(H)}}var Aa=new c.layer.Group({layers:ya}),Ba=null;Aa.getLayers().forEach(function(a){a.setVisible(!1);Ba=a});Ba.setVisible(!0);var Ca=new c.View({center:[0,0],zoom:2,minZoom:2}),Da=new c.interaction.Select({layers:[va],style:function(a){var b=a.get("stageposition");if(!a.get("geometrysolved")){oa.getText().setText(""+b);return[oa]}na.getText().setText(""+b);return[na]},filter:function filter(a){if(0===a.get("stageposition")){return!1}return!0}}),Ea=new c.Feature;Ea.setProperties({name:"user_accuracy"});Ea.setStyle(qa);var Fa=new c.Feature;Fa.setProperties({name:"user_position"});Fa.setStyle(pa);var Ga=new c.layer.Vector({source:new c.source.Vector({features:[Ea,Fa]})}),Ha=new c.Feature;Ha.setGeometry(null);Ha.setStyle(ra);var Ia=new c.layer.Vector({source:new c.source.Vector({features:[Ha]})});sa.push(Aa);sa=sa.concat(za);sa=sa.concat([va,Ga,Ia]);var Ja=new c.control.Zoom({target:"navigation",className:"custom-zoom"}),Ka=new c.Map({layers:sa,controls:[Ja],target:"mapplay",view:Ca,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});Ka.addInteraction(Da);u(!1,!0);Z=setInterval(function(){u(!1,!1)},n);(function(b){b.getLayers().forEach(function(c){var d=a("<li>",{"data-icon":"check",class:c.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:c.get("name"),href:"#mappage"}).click(function(){b.getLayers().forEach(function(a){if(a===c){a.setVisible(!0)}else{a.setVisible(!1)}})}));c.on("change:visible",function(){a(d).toggleClass("checked unchecked")});d.insertAfter("#baseLayer")})})(Aa);za.forEach(function(a){z(a)});if(o&&p){var La=f.addgpxlayer(Ka,h,i,g,p,"trackgroup");La.set("name",La.get("title"));var Ma=La.getLayers().item(0),Na=Ma.get("title"),Oa=Na.substring(Na.indexOf("</a>")+4);Ma.set("name",Oa);Ma.setVisible(!1);z(Ma)}function r(){if(j&&null===Ha.getGeometry()){C(g.nomarks)}else{u(!0,!1)}}function s(){position=Pa.getPosition();t(Ka,position)}function t(a,b,c){var d=a.getView();if(c){d.fit(c,{duration:700})}else{d.animate({zoom:J,center:b,duration:700})}}function u(b,c,e,f){var h,n,p,q;if(j){p=Ha.getGeometry()}else{p=Fa.getGeometry()}if(p){n=ta.writeGeometryObject(p,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})}if(e){a.mobile.loading("show");q=e}if(b){h=n;a.mobile.loading("show")}var r=d.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:i,attempttimestamp:l,roadtimestamp:m,playwithoutmoving:j,groupmode:k,initialize:c,location:h,currentposition:o&&!j?n:void 0,selectedanswerid:q,qoaremoved:ia,qrtext:f}}}]);r[0].done(function(d){var f="";ia=d.qoaremoved;ga=d.roadfinished;ha=d.available;a.mobile.loading("hide");if(b||e){if(null!==d.status&&ha){console.log(d.status.msg)}}if(d.qrexpected){a("#validateqr").show()}else{a("#validateqr").hide()}if(j!=d.playwithoutmoving){j=d.playwithoutmoving;if(!j){Ha.setGeometry(null)}}if(k!=d.groupmode){k=d.groupmode}if(l!==d.attempttimestamp||m!==d.roadtimestamp||c||!ha){l=d.attempttimestamp;m=d.roadtimestamp;if(0<d.historicalattempts.length){ba=d.historicalattempts;ca=!0}if(d.attempts||d.firststagegeom){ua.clear();if(d.firststagegeom){ua.addFeatures(ta.readFeatures(d.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}if(0<d.attempts.features.length){ua.addFeatures(ta.readFeatures(d.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}}if(d.lastsuccessfulstage){Y=d.lastsuccessfulstage;da=!0;if(""!==Y.question){ea=!0;a("#validatelocation").hide();a("#question_button").show()}else if(!Y.activitysolved){a("#validatelocation").hide();a("#question_button").show()}else{a("#validatelocation").show();a("#question_button").hide()}}if(d.firststagegeom||c){fa=!0}var h=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");w();v();x();if("mappage"===h){}else if("historypage"===h){y()}else if("questionpage"===h){if(""===Y.question){a.mobile.pageContainer.pagecontainer("change","#mappage")}else{a.mobile.resetActivePageHeight()}}}if(0<d.infomsg.length){aa.forEach(function(a){f+="<p>"+a+"</p>"});d.infomsg.forEach(function(a){aa.push(a);f+="<p>"+a+"</p>"});D("displayupdates",g.updates,f)}if(!ga){a("#roadended").hide()}if(ga||!ha){a("#validatelocation").hide();a("#question_button").hide();a("#roadended").show();Ha.setGeometry(null);j=!1;clearInterval(Z);a("#mapplay").css("opacity","0.8")}}).fail(function(a){console.log(a);D("displayerror",g.error,a.message);clearInterval(Z)})}function v(){if(fa){var a=ua.getFeatures();if(1===a.length&&a[0].getGeometry()instanceof c.geom.Point){t(Ka,a[0].getGeometry().getCoordinates())}else{t(Ka,null,ua.getExtent())}fa=!1}}function w(){if(da){a("#lastsuccessfulstagename").text(g.stage+":"+Y.name);a("#lastsuccesfulstagepos").text(Y.position+" / "+Y.totalnumber);var b;Y.clue=Y.clue.replace(/color/gm,"color-disabled");a("#lastsuccessfulstageclue").html(Y.clue);var c=Y.clue.replace(/<(?:.|\n)*?>/gm,"");if(c.length>200){a("#lastsuccessfulstageclue").truncate(200);b=" <a href=\"#historypage\" data-transition=\"none\" class=\"ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-icon-info ui-btn-icon-notext\"></a> ";a("#lastsuccessfulstageclue").append(b)}else{b=Y.clue}a("#lastsuccessfulstagename2").text(Y.name);a("#lastsuccesfulstagepos2").text(Y.position+" / "+Y.totalnumber);a("#lastsuccessfulstageclue2").html(Y.clue);if(""!==Y.question){a("#lastsuccessfulstageclue").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+g.question+"</a>");a("#lastsuccessfulstageclue2").append("<a href='#questionpage' data-transition='none' class='ui-btn ui-shadow ui-corner-all ui-btn-icon-left ui-btn-inline ui-mini ui-icon-comment'>"+g.question+"</a>")}a("#collapsibleset").collapsibleset("refresh");a("#infopanel").panel("open");a("#lastsuccessfulstage").collapsible("expand");da=!1}}function x(){if(ea){Y.question=Y.question.replace(/color/gm,"color-disabled");a("#questionform").html("<legend>"+Y.question+"</legend>");var b=1;a.each(Y.answers,function(c,d){var e="answer"+b;d.answertext=d.answertext.replace(/color/gm,"color-disabled");a("#questionform").append("<input type=\"radio\" name=\"answers\" id=\""+e+"\"value=\""+d.id+"\"><label for=\""+e+"\">"+d.answertext+"</label>");b++});ea=!1}}function y(){if(ca){var b=a("#historylist");b.html("");ca=!1;if(0===ba.length){a("<li>"+g.noattempts+"</li>").appendTo(b)}else{ba.forEach(function(c){a("<li><span class='ui-btn-icon-left "+(c.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+c.string+"</li>").appendTo(b)})}b.listview("refresh");b.trigger("updatelayout")}}function z(b){var c=a("<li>",{"data-icon":"check",class:b.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:b.get("name"),href:"#mappage"}).click(function(){b.setVisible(!b.getVisible())}));b.on("change:visible",function(){a(c).toggleClass("checked unchecked")});c.insertAfter("#baseLayer")}var Pa=new c.Geolocation({projection:Ca.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});Pa.on("change:position",function(){var b=this.getPosition();Fa.setGeometry(b?new c.geom.Point(b):null);if(this.get("center")){t(Ka,b);this.setProperties({center:!1})}if(this.get("validate_location")){u(!0,!1);this.setProperties({validate_location:!1})}a.mobile.loading("hide")});Pa.on("change:accuracyGeometry",function(){Ea.setGeometry(this.getAccuracyGeometry());a.mobile.loading("hide")});var Qa=!1;Pa.on("error",function(b){a.mobile.loading("hide");Pa.setProperties({user_denied:!0});C(b.message);if(b.code==b.PERMISSION_DENIED&&o&&!j&&!1==Qa){setTimeout(function(){a("#popupgeoloc").popup("open",{positionTo:"window"});Qa=!0},500)}});Pa.setTracking(o);Da.on("select",function(b){if(1===b.selected.length){if(Y.position===b.selected[0].get("stageposition")&&b.selected[0].get("geometrysolved")&&!ga&&ha){a("#infopanel").panel("open");a("#lastsuccessfulstage").collapsible("expand")}else{var c,d=b.selected[0].get("name"),e=b.selected[0].get("clue"),f=b.selected[0].get("info"),h="";if(b.selected[0].get("geometrysolved")){if(d&&e){c=g.stageovercome;h=G(g.stagename,d);h+=G(g.stageclue,e)}else{c=g.discoveredlocation}}else{c=g.failedlocation}if(f){h+="<p>"+f+"</p>"}D("infostage",c,h)}}});Ka.on("click",function(a){var b=!1;Ka.forEachFeatureAtPixel(Ka.getEventPixel(a.originalEvent),function(a){if(0===a.get("stageposition")||"user_position"===a.get("name")||"user_accuracy"===a.get("name")){return!1}b=!0});if(j&&!b){var d=Ka.getEventCoordinate(a.originalEvent);Ha.setGeometry(d?new c.geom.Point(d):null)}});a("#autocomplete").on("filterablebeforefilter",function(b,d){if(!I){return}var e=a(this),f=a(d.input).val();e.html("");if(f&&2<f.length){a.mobile.loading("show",{text:g.searching,textVisible:!0,theme:"b"});X.geocode(f,function(b){if(!1===b[0]){e.html("<li data-filtertext='"+f+"'>"+g.noresults+"</li>")}else{a.each(b,function(b,d){a("<li data-filtertext='"+f+"'>").hide().append(a("<a href='#'>").text(d.totalName).append(a("<p>").text(d.type))).appendTo(e).click(function(){var b=[parseFloat(d.boundingbox[2]),parseFloat(d.boundingbox[0]),parseFloat(d.boundingbox[3]),parseFloat(d.boundingbox[1])];b=c.proj.transformExtent(b,"EPSG:4326","EPSG:3857");t(Ka,null,b);a("#searchpanel").panel("close")}).show()})}e.listview("refresh");e.trigger("updatelayout");a.mobile.loading("hide")})}});a("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(){var b=a("#infopanel .ui-panel-inner");b.animate({scrollTop:parseInt(a(this).offset().top-b.offset().top+b.scrollTop())},500)});a(document).on("popupbeforeposition",function(){var b=a(window).height()-200+"px";a(".ui-popup [data-role=\"content\"]").css("max-height",b)});a(document).on("popupafterclose",".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)",function(){a(this).remove();Da.getFeatures().clear()});a(document).on("click","#acceptupdates",function(){aa=[]});a(window).on("pagecontainershow resize",function(b){a.mobile.resetActivePageHeight();var c=a.mobile.pageContainer.pagecontainer("getActivePage").prop("id");if("mappage"===c){if("resize"===b.type){setTimeout(function(){Ka.updateSize()},200)}else{Ka.updateSize();v()}}else if("historypage"===c){if("pagecontainershow"===b.type){y()}}else if("questionpage"===c){if("pagecontainershow"===b.type){if(""===Y.question){a.mobile.pageContainer.pagecontainer("change","#mappage")}else{x()}}}});if(I){a("#autolocate").on("click",function(){if(Pa.get("user_denied")){a("#popupgeoloc").popup("open",{positionTo:"window"})}else{s(!0)}})}a("#infopanel").panel({beforeclose:function beforeclose(){Da.getFeatures().clear()}});a("#sendLocation").on("click",function(){r(!0)});a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");if(!ha){b.preventDefault();C(g.timeexceeded)}else{if(0===c.length){b.preventDefault();C(g.noanswerselected)}else{u(!1,!1,c.val())}}});a("#validatelocation").on("click",function(b){if(ga){b.preventDefault();C(g.huntcompleted);return}if(!ha){b.preventDefault();C(g.timeexceeded);return}if(""!==Y.question){b.preventDefault();C(g.answerwarning);a("#infopanel").panel("open");return}if(!Y.activitysolved){b.preventDefault();C(g.activitytoendwarning);a("#infopanel").panel("open")}});if(!1===a.mobile.autoInitializePage){a("#container").show();a("#loader").remove();a.mobile.initializePage();var Ra=document.querySelector("meta[name=viewport]");Ra.setAttribute("content","width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0");a("#QRdialog").popup({beforeposition:function beforeposition(){a(this).width(.9*window.innerWidth);a(this).height(.9*window.innerHeight)},afteropen:function afteropen(){var b=a(this).find("div[data-role='content']").first(),c=a(this).find("div[data-role='header']").first(),d=parseInt(b.css("padding-top"))+parseInt(b.css("padding-bottom"));b.css("max-height","1000px");a("#previewVideoDiv").width(a(this).width()-d).height(a(this).height()-a("#previewQRbuttons").height()-c.height()-2*d);a("#previewQRvideo").show();loadQR(A,B)},afterclose:function afterclose(){unloadQR(B)}})}a("#nextcamera").on("click",function(){if(null!==detectedCameras){var a=getnextwebCam();C("Give access to:"+detectedCameras[a].name)}setnextwebcam(B)});function A(b){F(a("#QRdialog"));console.log(b);C("QR code readed: "+b);u(!1,!1,null,b)}function B(b){if("string"==typeof b){a("#errorQR").text(b)}else{if(null!==b.cameras[b.camera].name){a("#errorQR").text(b.cameras[b.camera].name)}if(1<b.cameras.length){a("#nextcamera").show()}else{a("#nextcamera").hide()}}}function C(b){if(0<a(".toast").length){setTimeout(function(){C(b)},2500)}else{a("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+b+"</p></div>").css({left:(a(window).width()-284)/2,top:a(window).height()/2}).appendTo(a.mobile.pageContainer).delay(2e3).fadeOut(400,function(){a(this).remove()})}}function D(b,c,d){var e=a("<div data-role=\"header\"><h2>"+c+"</h2></div>"),f=a("<div data-role=\"content\" class=\"ui-content ui-overlay-b\">"+d+"</div>"),i=a("<div data-role=\"popup\" id=\""+b+"\"data-theme=\"b\" data-transition=\"slidedown\"></div>");if("infostage"===b){a("<a href=\"#\" data-rel=\"back\" class=\"ui-btn ui-corner-allui-btn-b ui-icon-delete ui-btn-icon-notext ui-btn-right\"></a>").appendTo(e)}if("displayupdates"===b){a("<p class=\"center-wrapper\"><a id=\"acceptupdates\" href=\"#\" data-rel=\"back\"class=\"ui-btn center-button ui-mini ui-btn-inline\">"+g["continue"]+"</a></p>").appendTo(f);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}if("displayerror"===b){a("<p class=\"center-wrapper\"><a href=\"view.php?id="+h+"\" class=\"ui-btn  center-button ui-mini ui-icon-forward ui-btn-inline ui-btn-icon-left\"data-ajax=\"false\">"+g["continue"]+"</a></p>").appendTo(f);var j={"data-dismissible":!1,"data-overlay-theme":"b"};a(i).attr(j)}a(e).appendTo(a(i).appendTo(a.mobile.activePage).popup()).toolbar().after(f);_=a(f).find("img");if(0<_.length){a.mobile.loading("show");_.one("load",function(){$++;if(_.length===$){E(i);$=0;clearTimeout(k);a.mobile.loading("hide")}});var k=setTimeout(function(){E(i);a.mobile.loading("hide")},2e3)}else{E(i)}}function E(b){if(0<a(".ui-popup-active").length){a(".ui-popup").popup("close");setTimeout(function(){a(b).popup("open",{positionTo:"window"})},1e3)}else{a(b).popup("open",{positionTo:"window"})}}function F(a){a.popup("close")}function G(a,b){return"<div class=\"ui-bar ui-bar-a\">"+a+"</div><div class=\"ui-body ui-body-a\">"+b+"</div>"}}});
//# sourceMappingURL=play_old.min.js.map
