define ("mod_treasurehunt/viewgpx",["jquery","jqueryui","mod_treasurehunt/jquery-ui-touch-punch","core/notification","mod_treasurehunt/ol","mod_treasurehunt/ol3-layerswitcher","core/str"],function(a,b,c,d,e,f,g){console.log("Loading viewgpx.js with jquery "+a().jquery);var m=30,n=0;return{addgpxlayer:function addgpxlayer(a,b,c,d,e,f){var g=i(a,f);k([e],b,a,g,null);return g},creategpxviewer:function creategpxviewer(a,b,c,d,e){console.log("Creating gpxviewer.");var f=["aerialmap","roadmap","basemaps","searchlocation","trackviewer"],i=f.map(function(a){return{key:a,component:"treasurehunt"}});m=e;if("global"==c){var c=users_param}g.get_strings(i).done(function(e){console.log("I18N strings loaded.");for(var g=[],j=0;j<f.length;j++){g[f[j]]=e[j]}if("undefined"!=typeof d&&null!==d&&null!==d.custombackgroundurl){var k=new Image;k.addEventListener("load",function(){d.imgwidth=this.naturalWidth;d.imgheight=this.naturalHeight;h(a,b,g,c,d)});k.src=d.custombackgroundurl}else{h(a,b,g,c,d)}})}};function h(b,c,d,f,g){console.log("Init gpx viewer.");var j=null;if("undefined"!=typeof g&&null!=g){if(null!=g.custombackgroundurl){var o=e.proj.transformExtent(g.bbox,"EPSG:4326","EPSG:3857");if(!g.geographic){var p=o[2]-o[0],q=o[3]-o[1],r=(o[2]+o[0])/2,s=(o[3]+o[1])/2,t=Math.round(q/g.imgheight),u=Math.round(g.imgwidth*t),v=Math.round(g.imgheight*t);o=[r-u/2,s-v/2,r+u/2,s+v/2]}j=new e.layer.Image({title:g.layername,type:g.layertype,source:new e.source.ImageStatic({url:g.custombackgroundurl,imageExtent:o}),opacity:1})}else if(null!=g.wmsurl){var w={source:new e.source.TileWMS({url:g.wmsurl,params:g.wmsparams}),type:g.layertype,title:g.layername};if(null!=g.bbox[0]&&null!=g.bbox[1]&&null!=g.bbox[2]&&null!=g.bbox[3]){var x=e.proj.transformExtent(g.bbox,"EPSG:4326","EPSG:3857");w.extent=x}j=new e.layer.Tile(w)}g.geographic}var y=new e.layer.Group({title:d.basemaps,layers:[new e.layer.Tile({title:d.aerialmap,type:"base",visible:!1,source:new e.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})}),new e.layer.Tile({title:d.roadmap,type:"base",visible:!0,source:new e.source.OSM})]});if(null!==j){if(g.onlybase){y.getLayers().clear()}y.getLayers().push(j)}var z=new e.layer.Group({title:d.trackviewer,layers:[]}),A=new e.layer.Heatmap({title:"Heatmap",source:new e.source.Vector({url:"gpx.php?id="+b+"&userid=24",format:new e.format.GPX}),blur:20,radius:10}),B=new e.control.LayerSwitcher,C=new e.Map({layers:[y,z],renderer:"canvas",target:document.getElementById("mapgpx"),view:new e.View({center:[0,0],zoom:2,minZoom:2}),controls:e.control.defaults().extend([B])});console.log("Map created in mapgpx!");B.showPanel();var D=new e.interaction.Select({style:function style(a){var b=D.getLayer(a),c=b.iconurl,d=l(a,c,!0);return d}});C.addInteraction(D);k(f,b,C,z,B);var E=new e.Overlay({element:document.getElementById("info")});C.addOverlay(E);function h(a){var b=[],c="";C.forEachFeatureAtPixel(a,function(a){b.push(a)});if(0<b.length){var d=[],e,f;for(e=0,f=b.length;e<f;++e){d.push(b[e].get("desc"))}c=d.join(", ")||"(unknown)";C.getTarget().style.cursor="pointer"}else{C.getTarget().style.cursor=""}return c}function i(b){var c=E.getElement(),d=b.coordinate;a(c).popover("destroy");E.setPosition(d);a(c).popover({placement:"top",animation:!1,html:!0,content:h(C.getEventPixel(b.originalEvent))});a(c).popover("show")}C.on("pointermove",function(a){if(a.dragging){}});C.on("click",function(a){i(a)});var F=null;a("#refreshtracks").change(function(){if(a(this).is(":checked")){n=0;a("#timecircle").show();F=setInterval(function(){a("#timecircle").text(m-n++%m)},1e3)}else{a("#timecircle").hide();clearInterval(F)}})}function i(a,b){var c=null,d=a.getLayers();d.forEach(function(a){if(a.get("title")==b){c=a}});if(!c){c=new e.layer.Group({title:b,layers:[]});a.addLayer(c)}return c}function j(a,b,c){var d=a.getView();if(c){d.fit(c,{duration:700})}else{d.animate({zoom:19,center:b,duration:700})}}function k(b,c,d,f,g){var h=null;b.forEach(function(i){var k=new e.source.Vector({url:"gpx.php?id="+c+"&userid="+i.id,format:new e.format.GPX}),o=i.pic.indexOf("<img src=\"")+10,p=i.pic.indexOf("\"",o),b=i.pic.substring(o,p),q=new e.layer.Vector({source:k,title:i.pic+""+i.fullname,style:function style(a){var c=l(a,b,!1);return c}});q.iconurl=b;setInterval(function(){if(a("#refreshtracks").is(":checked")){n=0;k.clear();k.refresh()}},1e3*m);q.on("change:visible",function(){if(this.getVisible()){var a=this.getSource().getExtent();j(d,null,a)}});k.on("change",function(){if(a("#refreshtracks").is(":checked")){return}var b=k.getExtent();if(null===h){h=b}else{h[0]=Math.min(h[0],b[0]);h[1]=Math.min(h[1],b[1]);h[2]=Math.max(h[2],b[2]);h[3]=Math.max(h[3],b[3])}j(d,null,h)},this);f.getLayers().push(q);if(g){g.renderPanel()}})}function l(a,b,c){var d=[new e.style.Style({stroke:new e.style.Stroke({color:"rgba(255,255,255,0.8)",width:6+2*c}),zIndex:1+4*c}),new e.style.Style({stroke:new e.style.Stroke({color:"#ff0000",width:1+c,lineDash:[10,8]}),fill:new e.style.Fill({color:"rgba(255,0,0,0.5)"}),zIndex:2+4*c}),new e.style.Style({image:new e.style.Circle({radius:3+2*c,stroke:new e.style.Stroke({color:"white",width:1+c}),fill:new e.style.Fill({color:"red"})}),geometry:function(a){var b=a.getGeometry().getCoordinates()[0];return new e.geom.MultiPoint(b)},zIndex:3+4*c})],f=a.getGeometry(),g=f.getLastCoordinate();d.push(new e.style.Style({geometry:new e.geom.Point(g),image:new e.style.Icon({src:b,anchor:[.75,.5],rotateWithView:!1}),zIndex:4+4*c}));return d}});
//# sourceMappingURL=viewgpx.min.js.map
