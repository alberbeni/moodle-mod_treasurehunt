define ("mod_treasurehunt/play",["jquery","core/url","mod_treasurehunt/ol","core/ajax","mod_treasurehunt/geocoder","mod_treasurehunt/osm-geocoder","mod_treasurehunt/viewgpx","core/str","mod_treasurehunt/jquery.truncate"],function(a,b,c,d,e,f,g,h){return{playtreasurehunt:function playtreasurehunt(a,b,c,d,e,f,g,j,k,l){var m=["stageovercome","failedlocation","stage","stagename","stageclue","question","noanswerselected","timeexceeded","searching","continue","noattempts","aerialview","roadview","noresults","startfromhere","nomarks","updates","activitytoendwarning","huntcompleted","discoveredlocation","answerwarning","error"],n=m.map(function(a){return{key:a,component:"treasurehunt"}});h.get_strings(n).done(function(h){for(var n=[],o=0;o<m.length;o++){n[m[o]]=h[o]}if("undefined"!=typeof l&&l&&l.custombackgroundurl){var p=new Image;p.addEventListener("load",function(){l.imgwidth=this.naturalWidth;l.imgheight=this.naturalHeight;i(n,a,b,c,d,e,f,g,j,k,l)});p.src=l.custombackgroundurl}else{i(n,a,b,c,d,e,f,g,j,k,l)}})}};function i(e,h,i,j,k,l,m,n,o,p,q){var B=null,C=!0,D=19;if(q){if(q.custombackgroundurl){var E=c.proj.transformExtent(q.bbox,"EPSG:4326","EPSG:3857");if(!q.geographic){var F=E[3]-E[1],G=(E[2]+E[0])/2,H=(E[3]+E[1])/2,I=Math.round(F/q.imgheight),J=Math.round(q.imgwidth*I),K=Math.round(q.imgheight*I);E=[G-J/2,H-K/2,G+J/2,H+K/2];D=5}B=new c.layer.Image({title:q.layername,name:q.layername,type:q.layertype,source:new c.source.ImageStatic({url:q.custombackgroundurl,imageExtent:E}),opacity:1})}else if(q.wmsurl){var L={source:new c.source.TileWMS({url:q.wmsurl,params:q.wmsparams}),type:q.layertype,title:q.layername,name:q.layername};if(q.bbox[0]&&q.bbox[1]&&q.bbox[2]&&q.bbox[3]){var M=c.proj.transformExtent(q.bbox,"EPSG:4326","EPSG:3857");L.extent=M}B=new c.layer.Tile(L)}C=q.geographic}if(!1===C){j=!0;a("#autolocate").hide()}var N=b.imageUrl("success_mark","treasurehunt"),O=b.imageUrl("failure_mark","treasurehunt"),P=b.imageUrl("my_location","treasurehunt"),Q={},R,S=[],T=[],U=!1,V=!1,W=!1,X=!1,Y=!0,Z=!1,$,_=0,aa=new c.style.Text({textAlign:"center",scale:1.3,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#000",width:3.5})}),ba=new c.style.Text({textAlign:"center",scale:1.4,fill:new c.style.Fill({color:"#fff"}),stroke:new c.style.Stroke({color:"#3399CC",width:3.5})}),ca=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:N}),text:aa,zIndex:"Infinity"}),da=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.5,src:O}),text:aa,zIndex:"Infinity"}),ea=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:N}),text:ba,zIndex:"Infinity"}),fa=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.75,src:O}),text:ba,zIndex:"Infinity"}),ga=new c.style.Style({image:new c.style.Circle({radius:6,fill:new c.style.Fill({color:[0,0,0,1]}),stroke:new c.style.Stroke({color:[255,255,255,1],width:2})})}),ha=new c.style.Style({fill:new c.style.Fill({color:[255,255,255,.3]}),stroke:new c.style.Stroke({color:[0,0,0,.5],width:1}),zIndex:-1}),ia=new c.style.Style({image:new c.style.Icon({anchor:[.5,1],opacity:1,scale:.35,src:P})}),ja=[],ka=new c.format.GeoJSON,la=new c.source.Vector({projection:"EPSG:3857"}),ma=new c.layer.Vector({source:la,style:function(a){var b=a.get("stageposition");if(0===b){var d=new c.style.Fill({color:"rgba(255,255,255,0.4)"}),f=new c.style.Stroke({color:"#3399CC",width:1.25}),g=new c.style.Style({image:new c.style.Circle({fill:d,stroke:f,radius:5}),fill:d,stroke:f,text:new c.style.Text({text:e.startfromhere,textAlign:"center",fill:new c.style.Fill({color:"rgb(255,255,255)"}),stroke:new c.style.Stroke({color:"#3399CC",width:5})})});return[g]}if(!a.get("geometrysolved")){da.getText().setText(""+b);return[da]}ca.getText().setText(""+b);return[ca]}}),na=new c.layer.Tile({visible:!1,source:new c.source.BingMaps({key:"AmC3DXdnK5sXC_Yp_pOLqssFSaplBbvN68jnwKTEM3CSn2t6G5PGTbYN3wzxE5BR",imagerySet:"AerialWithLabels",maxZoom:19})});na.set("name",e.aerialview);var oa=new c.layer.Tile({source:new c.source.OSM});oa.set("name",e.roadview);var pa=[],qa=[];if(!q||!1===q.onlybase){pa=[na,oa]}if(B){if("overlay"!=q.layertype){pa.push(B)}else{qa.push(B)}}var ra=new c.layer.Group({layers:pa}),sa=null;ra.getLayers().forEach(function(a){a.setVisible(!1);sa=a});sa.setVisible(!0);var ta=new c.View({center:[0,0],zoom:2,minZoom:2}),ua=new c.interaction.Select({layers:[ma],style:function(a){var b=a.get("stageposition");if(!a.get("geometrysolved")){fa.getText().setText(""+b);return[fa]}ea.getText().setText(""+b);return[ea]},filter:function filter(a){if(0===a.get("stageposition")){return!1}return!0}}),va=new c.Feature;va.setProperties({name:"user_accuracy"});va.setStyle(ha);var wa=new c.Feature;wa.setProperties({name:"user_position"});wa.setStyle(ga);var xa=new c.layer.Vector({source:new c.source.Vector({features:[va,wa]})}),ya=new c.Feature;ya.setGeometry(null);ya.setStyle(ia);var za=new c.layer.Vector({source:new c.source.Vector({features:[ya]})});ja.push(ra);ja=ja.concat(qa);ja=ja.concat([ma,xa,za]);var Aa=new c.control.Zoom({target:"navigation",className:"custom-zoom"}),Ba=new c.Map({layers:ja,controls:[Aa],target:"mapplay",view:ta,loadTilesWhileAnimating:!0,loadTilesWhileInteracting:!0});Ba.addInteraction(ua);u(!1,!0);R=setInterval(function(){u(!1,!1)},n);(function(b){b.getLayers().forEach(function(c){var d=a("<li>",{class:c.getVisible()?"checked close-modal":"unchecked close-modal"}).append(a("<a />",{text:c.get("name"),href:"#mappage"}).click(function(){b.getLayers().forEach(function(a){if(a===c){a.setVisible(!0)}else{a.setVisible(!1)}})}));c.on("change:visible",function(){a(d).toggleClass("checked unchecked")});d.insertAfter("#baseLayer")})})(ra);qa.forEach(function(a){y(a)});if(o&&p){var Ca=g.addgpxlayer(Ba,h,i,e,p,"trackgroup");Ca.set("name",Ca.get("title"));var Da=Ca.getLayers().item(0),Ea=Da.get("title"),Fa=Ea.substring(Ea.indexOf("</a>")+4);Da.set("name",Fa);Da.setVisible(!1);y(Da)}function r(){if(j&&!ya.getGeometry()){z(e.nomarks)}else{u(!0,!1)}}function s(){var a=Ga.getPosition();t(Ba,a)}function t(a,b,c){var d=a.getView();if(c){d.fit(c,{duration:700})}else{d.animate({zoom:D,center:b,duration:700})}}function u(b,c,e,f){var g,h,n,p;if(j){n=ya.getGeometry()}else{n=wa.getGeometry()}if(n){h=ka.writeGeometryObject(n,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"})}if(e){p=e}if(b){g=h}var q=d.call([{methodname:"mod_treasurehunt_user_progress",args:{userprogress:{treasurehuntid:i,attempttimestamp:l,roadtimestamp:m,playwithoutmoving:j,groupmode:k,initialize:c,location:g,currentposition:o&&!j?h:void 0,selectedanswerid:p,qoaremoved:Z,qrtext:f}}}]);q[0].done(function(d){Z=d.qoaremoved;X=d.roadfinished;Y=d.available;if(b||e){if(d.status&&Y){}}if(d.qrexpected){a("#validateqr").show()}else{a("#validateqr").hide()}if(j!=d.playwithoutmoving){j=d.playwithoutmoving;if(!j){ya.setGeometry(null)}}if(k!=d.groupmode){k=d.groupmode}if(l!==d.attempttimestamp||m!==d.roadtimestamp||c||!Y){l=d.attempttimestamp;m=d.roadtimestamp;if(0<d.historicalattempts.length){T=d.historicalattempts;U=!0}if(d.attempts||d.firststagegeom){la.clear();if(d.firststagegeom){la.addFeatures(ka.readFeatures(d.firststagegeom,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}if(0<d.attempts.features.length){la.addFeatures(ka.readFeatures(d.attempts,{dataProjection:"EPSG:4326",featureProjection:"EPSG:3857"}))}}if(d.lastsuccessfulstage){Q=d.lastsuccessfulstage;changesinlastsuccessfulstage=!0;if(""!==Q.question){V=!0;a("#validatelocation").hide();a("#question_button").show()}else if(!Q.activitysolved){a("#validatelocation").hide();a("#question_button").show()}else{a("#validatelocation").show();a("#question_button").hide()}}if(d.firststagegeom||c){W=!0}v();w();x()}if(0<d.infomsg.length){S.forEach(function(){});d.infomsg.forEach(function(a){S.push(a)})}if(!X){a("#roadended").hide()}if(X||!Y){a("#validatelocation").hide();a("#question_button").hide();a("#roadended").show();ya.setGeometry(null);j=!1;clearInterval(R);a("#mapplay").css("opacity","0.8")}}).fail(function(){clearInterval(R)})}function v(){if(W){var a=la.getFeatures();if(1===a.length&&a[0].getGeometry()instanceof c.geom.Point){t(Ba,a[0].getGeometry().getCoordinates())}else{t(Ba,null,la.getExtent())}W=!1}}function w(){if(V){Q.question=Q.question.replace(/color/gm,"color-disabled");a("#questionform").html("<legend>"+Q.question+"</legend>");var b=1;a.each(Q.answers,function(c,d){var e="answer"+b;d.answertext=d.answertext.replace(/color/gm,"color-disabled");a("#questionform").append("<input type=\"radio\" name=\"answers\" id=\""+e+"\"value=\""+d.id+"\"><label for=\""+e+"\">"+d.answertext+"</label>");b++});V=!1}}function x(){if(U){var b=a("#historylist");b.html("");U=!1;if(0===T.length){a("<li>"+e.noattempts+"</li>").appendTo(b)}else{T.forEach(function(c){a("<li><span class='ui-btn-icon-left "+(c.penalty?"ui-icon-delete failedattempt":"ui-icon-check successfulattempt")+"' style='position:relative'></span>"+c.string+"</li>").appendTo(b)})}b.listview("refresh");b.trigger("updatelayout")}}function y(b){var c=a("<li>",{"data-icon":"check",class:b.getVisible()?"checked":"unchecked"}).append(a("<a />",{text:b.get("name"),href:"#mappage"}).click(function(){b.setVisible(!b.getVisible())}));b.on("change:visible",function(){a(c).toggleClass("checked unchecked")});c.insertAfter("#baseLayer")}var Ga=new c.Geolocation({projection:ta.getProjection(),trackingOptions:{enableHighAccuracy:!0,maximumAge:0,timeout:1e4}});Ga.on("change:position",function(){var a=this.getPosition();wa.setGeometry(a?new c.geom.Point(a):null);if(this.get("center")){t(Ba,a);this.setProperties({center:!1})}if(this.get("validate_location")){u(!0,!1);this.setProperties({validate_location:!1})}});Ga.on("change:accuracyGeometry",function(){va.setGeometry(this.getAccuracyGeometry())});var Ha=!1;Ga.on("error",function(b){Ga.setProperties({user_denied:!0});z(b.message);if(b.code==b.PERMISSION_DENIED&&o&&!j&&!1==Ha){setTimeout(function(){a("#popupgeoloc").popup("open",{positionTo:"window"});Ha=!0},500)}});Ga.setTracking(o);ua.on("select",function(b){if(1===b.selected.length){if(Q.position===b.selected[0].get("stageposition")&&b.selected[0].get("geometrysolved")&&!X&&Y){a("#infopanel").panel("open");a("#lastsuccessfulstage").collapsible("expand")}else{var c=b.selected[0].get("name"),d=b.selected[0].get("clue"),e=b.selected[0].get("info");if(b.selected[0].get("geometrysolved")){if(c&&d){}}if(e){}}}});Ba.on("click",function(a){var b=!1;Ba.forEachFeatureAtPixel(Ba.getEventPixel(a.originalEvent),function(a){if(0===a.get("stageposition")||"user_position"===a.get("name")||"user_accuracy"===a.get("name")){return!1}b=!0});if(j&&!b){var d=Ba.getEventCoordinate(a.originalEvent);ya.setGeometry(d?new c.geom.Point(d):null)}});a("#searchInput").on("input",function(b){if($){$.abort()}if(_){clearTimeout(_)}var d=a("#searchsResults"),g=b.target.value;d.html("");if(g&&2<g.length){_=setTimeout(function(){$=f.search(g).done(function(b){if(0===b.length){d.html("<li>"+e.noresults+"</li>")}else{a.each(b,function(b,e){a("<li class='search-option'>").hide().text(e.display_name).appendTo(d).click(function(){var a=[parseFloat(e.boundingbox[2]),parseFloat(e.boundingbox[0]),parseFloat(e.boundingbox[3]),parseFloat(e.boundingbox[1])];a=c.proj.transformExtent(a,"EPSG:4326","EPSG:3857");t(Ba,null,a);A("#searchpanel")}).show()})}}).fail(function(){}).always(function(){$=null})},400)}});a("#infopanel").on("collapsibleexpand","[data-role='collapsible']",function(){var b=a("#infopanel .ui-panel-inner");b.animate({scrollTop:parseInt(a(this).offset().top-b.offset().top+b.scrollTop())},500)});a(document).on("popupbeforeposition",function(){var b=a(window).height()-200+"px";a(".ui-popup [data-role=\"content\"]").css("max-height",b)});a(document).on("popupafterclose",".ui-popup:not(#QRdialog):not(#popupdialog):not(#popupgeoloc)",function(){a(this).remove();ua.getFeatures().clear()});a(document).on("click","#acceptupdates",function(){S=[]});a(window).on("resize",function(){Ba.updateSize()});if(C){a("#autolocate").on("click",function(){if(Ga.get("user_denied")){a("#popupgeoloc").popup("open",{positionTo:"window"})}else{s(!0)}})}a("#infopanel").panel({beforeclose:function beforeclose(){ua.getFeatures().clear()}});a("#sendLocation").on("click",function(){r(!0)});a("#sendAnswer").on("click",function(b){var c=a("#questionform input[type='radio']:checked");if(!Y){b.preventDefault();z(e.timeexceeded)}else{if(0===c.length){b.preventDefault();z(e.noanswerselected)}else{u(!1,!1,c.val())}}});a("#validatelocation").on("click",function(b){if(X){b.preventDefault();z(e.huntcompleted);return}if(!Y){b.preventDefault();z(e.timeexceeded);return}if(""!==Q.question){b.preventDefault();z(e.answerwarning);a("#infopanel").panel("open");return}if(!Q.activitysolved){b.preventDefault();z(e.activitytoendwarning);a("#infopanel").panel("open")}});function z(b){if(0<a(".toast").length){setTimeout(function(){z(b)},2500)}else{a("<div class='ui-loader ui-overlay-shadow  ui-corner-all toast'><p>"+b+"</p></div>").css({left:(a(window).width()-284)/2,top:a(window).height()/2}).appendTo(a("play-container")).delay(2e3).fadeOut(400,function(){a(this).remove()})}}function A(b){a(b).removeClass("active");a(".sidebar-mask").removeClass("active dismissible")}}});
//# sourceMappingURL=play.min.js.map
